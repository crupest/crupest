FROM alpine:latest AS coscli-downloader
RUN apk add --no-cache bash curl jq
COPY install-coscli.bash /install-coscli.bash
RUN /install-coscli.bash

FROM alpine:latest
RUN apk add --no-cache coreutils bash tar xz
ARG CRUPEST_AUTO_BACKUP_INIT_DELAY=0
ARG CRUPEST_AUTO_BACKUP_INTERVAL=1d
ARG CRUPEST_AUTO_BACKUP_COS_SECRET_ID
ARG CRUPEST_AUTO_BACKUP_COS_SECRET_KEY
ARG CRUPEST_AUTO_BACKUP_COS_REGION
ARG CRUPEST_AUTO_BACKUP_BUCKET_NAME
ENV CRUPEST_AUTO_BACKUP_INIT_DELAY=${CRUPEST_AUTO_BACKUP_INIT_DELAY}
ENV CRUPEST_AUTO_BACKUP_INTERVAL=${CRUPEST_AUTO_BACKUP_INTERVAL}
ENV CRUPEST_AUTO_BACKUP_COS_SECRET_ID=${CRUPEST_AUTO_BACKUP_COS_SECRET_ID}
ENV CRUPEST_AUTO_BACKUP_COS_SECRET_KEY=${CRUPEST_AUTO_BACKUP_COS_SECRET_KEY}
ENV CRUPEST_AUTO_BACKUP_COS_REGION=${CRUPEST_AUTO_BACKUP_COS_REGION}
ENV CRUPEST_AUTO_BACKUP_BUCKET_NAME=${CRUPEST_AUTO_BACKUP_BUCKET_NAME}
COPY --from=coscli-downloader /coscli /coscli
COPY daemon.bash /daemon.bash
VOLUME [ "/data", "/root/.cos.yaml" ]
STOPSIGNAL SIGINT
ENTRYPOINT [ "/daemon.bash" ]
